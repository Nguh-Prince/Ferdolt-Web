{% extends 'frontend/base-template.html' %}
{% load i18n static %}

{% block title %}DoDB | {% trans 'Databases' %}{% endblock %}

{% block breadcrumbs %}

{% if database %}
<li class="breadcrumb-item"><a href="{% url 'frontend:databases' %}">{% trans "Databases" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{database.name}}</li>
{% else %}
<li class="breadcrumb-item active"><a href="#">{% trans "Databases" %}</a></li>
{% endif %}

{% endblock %}

{% block extra_styles %}
<link href="{% static 'frontend/plugins/daterangepicker/daterangepicker.css' %}" rel="stylesheet" type="text/css" />

<style>
    .database-card:hover {
        background-color: rgba(0, 0, 0, 0.05);
        cursor: pointer;
    }

    .database-card .select-database {
        border-radius: 500%;
    }
</style>
{% endblock %}

{% block message_active %}active{% endblock %}
{% block messages %}
{% if database and not connection %}
<div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
        <img src="..." class="rounded me-2" alt="">
        <strong class="me-auto">DoDB</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"
            onclick="toggleMessages()"></button>
    </div>

    <div class="toast-body">
        {% blocktranslate with database.name as database_name %}
        We were unable to connect to the {{ database_name }} database, please ensure that your database server is running
        and your credentials are correct.
        {% endblocktranslate %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block tabs %}
{% if database %}
<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item active" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#general" id="general-tab"
            aria-current="page">{% trans "Tables" %}</button>
    </li>
    <li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#synchronizations" id="synchronizations-tab"
            aria-current="page">{% trans "Synchronizations" %}</button>
    </li>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#extractions" id="rewards-tab">{% trans "Extractions" %}</button>
    </li>
</ul>
{% endif %}
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    {% if not database %}
    <div class="row">
        <div class="col-sm-12">
            <div class="page-title-box">
                <div class="row justify-content-end">
                    <div class="col-auto align-self-center">
                        <button class="btn btn-outline-primary btn-sm add-file" data-bs-toggle="modal"
                            data-bs-target="#new-database-modal">
                            </i>{% trans "Add database" %}
                        </button>
                    </div>

                    <div class="col-auto align-self-center d-none" id="synchronize-databases-button">
                        <button class="btn btn-outline-orange btn-sm add-file" data-bs-toggle="modal"
                            data-bs-target="#synchronize-databases-modal">
                            </i>{% trans "Synchronize databases" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row py-2" id="databases">

    </div>
    {% else %}
    <div class="tab-content" id="my-tab-content">
        <div class="tab-pane fade show active my-2" id="general" role="tabpanel" aria-labelledby="general-tab">
            <div class="row {% if not pending_synchronizations %}d-none row-1{% endif %}">
                <div class="col-sm-12">
                    <div class="page-title-box row">
                        <div class="col-md-6 row">
                            {% if pending_synchronizations %}
                            <div class="d-flex flex-column align-items-center">
                                <div class="text-orange py-2">The {{ database.name }} database has {{ pending_synchronizations.count }} synchronizations pending</div>
                                <button class="btn btn-outline-orange" onclick="synchronizeDatabase()">
                                    {% trans "Apply synchronizations" %}
                                </button>
                            </div>
                            {% endif %}
                        </div>

                        <div class="row col-md-6 justify-content-end">
                            <div class="col-auto align-self-center d-none" id="action-buttons-container">
                                <button class="btn btn-outline-orange btn-sm mx-2" id="delete-many"
                                    data-bs-target="#extract-from-database" data-bs-toggle="modal">
                                    <i data-feather="upload" style="width: 16; height: 16;"></i> {% trans 'Synchronize' %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Create nested accordions for the schemas, tables and columns -->
            <ul class="cd-accordion cd-accordion--animated margin-top-lg margin-bottom-lg">
                {% for schema in database.databaseschema_set.all %}
                {% if schema.normal_tables %}
                <li class="cd-accordion__item cd-accordion__item--has-children schema">
                    <input type="checkbox" class="cd-accordion__input" name="{{ schema.name.lower }}-{{schema.id}}"
                        id="{{ schema.name.lower }}-{{schema.id}}" checked>

                    <label for="{{ schema.name.lower }}-{{schema.id}}"
                        class="cd-accordion__label cd-accordion__label--icon-folder">
                        <input type="checkbox" class="mx-2 select-all-tables schema-select"
                            name="select-{{ schema.name.lower }}-{{schema.id}}" data-schema-id="{{ schema.id }}">
                        <span>{{ schema.name }}</span></label>

                    <ul class="cd-accordion__sub cd-accordion__sub-11">
                        {% for table in schema.normal_tables %}
                        <li class="cd-accordion__item cd-accordion__item--has-children">
                            <input class="cd-accordion__input" type="checkbox"
                                name="{{ table.name.lower }}-{{table.id}}" id="{{ table.name.lower }}-{{table.id}}">
                            <label class="cd-accordion__label cd-accordion__label--icon-folder"
                                for="{{ table.name.lower }}-{{table.id}}">
                                <input type="checkbox" class="mx-2 select-table" data-table-id="{{ table.id }}"
                                    data-schema-id="{{ schema.id }}" name="select-{{ table.name.lower }}-{{table.id}}">
                                <span>{{ table.name }}</span></label>

                            <ul class="cd-accordion__sub cd-accordion__sub--l2">
                                <li class="cd-accordion__item">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>{% trans "Column name" %}</th>
                                                <th>{% trans "Data type" %}</th>
                                                <th>{% trans "Character max." %}</th>
                                                <th>{% trans "Datetime precision" %}</th>
                                                <th>{% trans "Numeric precision" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for column in table.column_set.all %}
                                            <tr>
                                                <td>{{ column.name }}</td>
                                                <td>{{ column.data_type }}</td>
                                                <td>{{ column.character_maximum_length }}</td>
                                                <td>{{ column.datetime_precision }}</td>
                                                <td>{{ column.numeric_precision }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </li>
                            </ul>
                        </li>
                        {% endfor %}
                    </ul>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div class="tab-pane fade show my-2" id="synchronizations" 
        role="tabpanel" aria-labelledby="synchronizations-tab">
            {% if synchronizations %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Time made</th>
                        <th>File</th>
                        <th>File size</th>
                        <th>Is applied</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody>
                    {% for synchronization in synchronizations %}
                    <tr>
                        <td>{{ synchronization.extraction.time_made }}</td>
                        <td>{{ synchronization.extraction.file.file.url }}</td>
                        <td>{{ synchronization.extraction.file.size }}</td>
                        <td>{{ synchronization.is_applied }}</td>
                        <td>
                            {% if not synchronization.is_applied %}
                                <button class="btn btn-outline-success">{% trans 'Apply' %}</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <span>{% trans "This database does not have any synchronizations" %}</span>
            {% endif %}
        </div>

        <div class="tab-pane fade show my-2" id="extractions" 
        role="tabpanel" aria-labelledby="extractions-tab">
            {% if extractions %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Time made</th>
                        <th>File</th>
                        <th>File size</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody>
                    {% for extraction in extractions %}
                    <tr>
                        <th>{{ extraction.extraction.time_made }}</th>
                        <th><a href="{{ extraction.extraction.file.file.url }}">
                            {{ extraction.extraction.file.file.name }}
                        </a></th>
                        <th>{{ extraction.extraction.file.size }}</th>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <span>{% trans "This database does not have any extractions" %}</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
{% if database %}
<div class="modal" id="extract-from-database">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">{% trans "Extract from " %} {{ database.name }}</div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="new-extraction-start-time-display" class="form-control" readonly
                        placeholder="{% trans 'Extraction start time' %}">
                    <input type="datetime" id="new-extraction-start-time" class="d-none">
                    <div class="input-group-append">
                        <span class="input-group-text" id="empty-new-extraction-start-time">
                            <i data-feather="delete"></i>
                        </span>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="target-databases" class="form-label">{% trans 'Target databases' %}</label>
                    <select multiple id="target-databases" class="form-select">
                        {% for database in databases %}
                        <option value="{{ database.id }}">{{ database.name.lower }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="extractFromDatabase()">{% trans "Submit" %}</button>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="modal" id="new-database-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">{% trans "Synchronize databases" %}</div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" id="submit-new-database-form">{% trans "Submit" %}</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="synchronize-databases-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">{% trans "Synchronize databases" %}</div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label for="synchronization-type">{% trans "Synchronization type" %}</label>
                    <select id="synchronization-type" class="form-select">
                        <option value="full">{% trans "Full synchronization" %}</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="synchronization-direction">{% trans "Synchronization direction" %}</label>
                    <select id="synchronization-direction" class="form-select">
                        <option value="bi">{% trans "Bi-directional" %}</option>
                    </select>
                </div>
                <div class="mb-3">
                    <table class="table table-striped">
                        <thead>
                            <th></th>
                            <th>{% trans "DBMS version" %}</th>
                            <th>{% trans "Database name" %}</th>
                            <th>{% trans "Host" %}</th>
                            <th>{% trans "Port" %}</th>
                        </thead>
    
                        <tbody>
                            
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-orange" id="submit-new-database-form">{% trans "Synchronize" %}</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'frontend/assets/js/moment.js' %}"></script>
<script src="{% static 'frontend/plugins/daterangepicker/daterangepicker.js' %}"></script>
<script src="{% static 'frontend/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'frontend/accordion/js/util.js' %}"></script>
<script src="{% static 'frontend/accordion/js/main.js' %}"></script>

{% if not database %}
<script>
    var SELECTED_DATABASES = []

    function displaySynchronizeDatabasesButton() {
        if (SELECTED_DATABASES.length < 2) {
            $("#synchronize-databases-button").addClass('d-none')
        } else {
            $("#synchronize-databases-button").removeClass('d-none')
        }

        populateSynchronizeDatabaseseModalTable()
    }

    function populateSynchronizeDatabaseseModalTable() {
        $("#synchronize-databases-modal tbody").html('')

        if (SELECTED_DATABASES.length >= 2) {
            SELECTED_DATABASES.map( (database) => {
                let row = createElement('tr')
                
                let keys = ["name", "clear_host", "clear_port"]
                
                let dbmsVersionIndex = 1 // the position of the cell that contains the dbms version

                for (let i=0; i<=4; i++) {
                    let cell = createElement('td')
                    $(row).append(cell)
                    
                    if (i == dbmsVersionIndex) {
                        // cell with dbms version
                        cell.textContent = `${database.version.dbms_object.name} ${database.version.version_number}`
                    } else {
                        cell.textContent = database[keys[i-(dbmsVersionIndex + 1)]]
                    }
                }

                $("#synchronize-databases-modal tbody").append(row)
            } )
        }
    }

    $(document).ready(function () {
        console.log("Doc is ready...")
        // get the databases from the API

        $.ajax({
            type: "GET",
            url: `http://${location.host}${API_URL}/ferdolt/dbms/`,
            success: function (data) {
                state.databaseManagementSystems = data
                init()
            },
            error: function (data) {
                // get the stuff from local storage instead
            }
        });

        $.ajax({
            type: "GET",
            url: `http://${location.host}${API_URL}/ferdolt/databases/?format=json`,
            contentType: 'application/json',
            success: function (data) {
                state.databases = data
                displayDatabases()
            }
        })
    })

    $('.select-database').change(function() {
    console.log('Select database changed')
    console.log($(this).prop('checked'))
    console.log('This is: ')
    console.log(this)})

    function init() {
        for (let dbms of state.databaseManagementSystems) {
            let option = createElement("option", [], { value: dbms['id'] })
            option.textContent = dbms["name"]

            $("#dbms-input").append(option)
        }

        displayDatabases()
    }

    function displayDatabases() {
        console.log("In displayDatabases(): ")
        console.log(state.databases)

        for (let database of state.databases) {
            displayDatabase(database)
        }
    }

    function addIdToSelectedDatabases(id) {
        for (let database of state.databases) {
            if (database.id == id) {
                SELECTED_DATABASES.push(database)
            }
        }
    }

    function removeIdFromSelectedDatabases(id) {
        SELECTED_DATABASES = SELECTED_DATABASES.filter(database => database.id != id)
    }

    function displayDatabase(databaseObject, containerSelector = "#databases") {
        console.log("Creating card...")

        let card = createElementsRecursively(
            {
                tag: "div",
                classes: ["card", "mx-1", "database-card"],
                attributes: { style: "width: 18rem;", id: `database-${databaseObject['id']}` },
                elements: [
                    {
                        tag: "div",
                        classes: ["card-body"],
                        attributes: {},
                        elements: [
                            {
                                tag: "h5",
                                classes: ["card-title"],
                                attributes: {}
                            },
                            {
                                tag: "h6",
                                classes: ["card-subtitle", "mb-2", "text-muted"]
                            },
                            {
                                tag: "p",
                                classes: ["card-text", "database-host"]
                            },
                            {
                                tag: "p",
                                classes: ["card-text", "database-port"]
                            },
                            {
                                tag: "a",
                                classes: ["btn", "btn-primary", "database-detail-link"],
                                attributes: { href: `${location.pathname}${databaseObject['id']}` }
                            },
                        ]
                    }
                ]
            }
        )

        console.log("Created card...")
        $(card).find(".card-title").text(databaseObject["name"])

        $(card).find('.card-subtitle').text(`${databaseObject['version']['dbms_object']['name']} ${databaseObject['version']['version_number']}`)
        $('.card')

        $(card).find('.database-host').text(`Host: ${databaseObject['clear_host']}`)
        $(card).find('.database-port').text(`Port: ${databaseObject['clear_port']}`)

        $(card).find('.database-detail-link').text("Details")
        $(containerSelector).append(card)

        let selectDatabaseContainer = createElement('div', ["px-2", "py-1"], 
        {style: "position: absolute; top: 0; left: 0"})
        $(card).append(selectDatabaseContainer)

        let selectDatabaseInput = createElement('input', ['form-check-input', 'select-database'], 
            {type: "checkbox", "data-database-id": databaseObject.id}
        )
        $(selectDatabaseContainer).append(selectDatabaseInput)

        $(selectDatabaseInput).change(function() {
            console.log("select database changed")

            let checked = $(this).prop('checked')

            if (checked) {
                // add database
                addIdToSelectedDatabases(databaseObject.id)
            } else {
                // remove database
                removeIdFromSelectedDatabases(databaseObject.id)
            }
        })

        $(card).click(function() {
            let selectDatabase = $(this).find('.select-database').first()
            console.log(selectDatabase)
            let checked = selectDatabase.prop('checked')
            
            selectDatabase.prop('checked', !checked)

            if (!checked) {
                // add database
                addIdToSelectedDatabases(databaseObject.id)

                displaySynchronizeDatabasesButton()
            } else {
                // remove database
                removeIdFromSelectedDatabases(databaseObject.id)

                displaySynchronizeDatabasesButton()
            }
        })

        console.log("Appended card...")
    }

    $("#dbms-input").change(function () {
        let value = $(this).val()
        console.log("DBMS input changed!")

        // get the option with this value
        let option = $(this).children(`option[value=${value}]`).first()

        console.log(option)

        if (option !== null) {
            let text = option.text()

            console.log("The option's text content: " + text)

            // checking if an SQL server option has been chosen
            let regex = /sql\s*server/gmi

            // add a field for instance name if an SQL Server option ws chosen
            if (regex.test(text)) {
                $("#instance-name-input").parent().removeClass("d-none")
            } else {
                $("#instance-name-input").parent().addClass("d-none")
            }
        }
    })

    $("#submit-new-database-form").click(
        function () {
            submitNewDatabaseForm()
        }
    )

    function submitNewDatabaseForm() {
        console.log("Submitting new database")
        formData = {
            version: {
                version_number: $("#dbms-version-input").val(),
                dbms: $('#dbms-input').val(),
                dbms_object: {
                    name: $(`#dbms-input option[value=${$("#dbms-input").val()}]`).text(),
                }
            },
            instance_name: $("#instance-name-input").val(),
            name: $("#database-name").val(),
            host: $("#database-host").val(),
            port: $("#database-port").val(),
            username: $("#database-username").val(),
            password: $("#database-password").val()
        }

        console.log("Data to submit")
        console.log(JSON.stringify(formData))

        $.ajax({
            type: 'POST',
            contentType: "application/json",
            url: `http://${location.host}${API_URL}/ferdolt/databases/`,
            data: JSON.stringify(formData),
            headers: {
                "X-CSRFTOKEN": getCookie("csrf_token")
            },
            success: function (data) {
                let flag = false;

                for (let server of state.databases) {
                    if (server.id == data.id)
                        flag = true;
                }

                if (!flag) {

                }
            },
            error: function (data) {
                console.log("error message: ")
                console.log(data.responseText)

                if (data.status == 400 || data.status == 500) {
                    console.log(JSON.stringify(formData));
                    console.log(formData);
                }
            }
        })

    }

</script>
{% endif %}

{% if database %}
<script>
    var NUMBER_OF_SELECTED_TABLES = 0;
    const DATABASE_ID = {{ database.id }}

    $("#empty-new-extraction-start-time").click(() => {
        console.log("Clicked the bspc button")
        $('#new-extraction-start-time').val('')
        $('#new-extraction-start-time-display').val('')
    })

    function extractFromDatabase() {
        let schemas = [];
        let schemaList = {};
        let targetDatabases = $("#target-databases").val()
        let startTime = $("#new-extraction-start-time").val()

        startTime = startTime ? startTime : null;

        console.log("Databases chosen: ")
        console.log(targetDatabases)

        // get all the selected tables
        $('.select-table:checked').each((index, element) => {
            schemaID = $(element).attr('data-schema-id')
            tableID = $(element).attr('data-table-id')

            if (schemaID && tableID) {
                if (!(schemaID in schemaList)) {
                    schemas.push({
                        schema: schemaID,
                        tables: [
                            {
                                table: tableID
                            }
                        ]
                    })

                    // add an object to the schemaList with the schema's index in the schemas array
                    schemaList[schemaID] = schemas.length - 1
                } else {
                    let index = schemaList[schemaID]

                    let schemaObject = schemas[index]
                    schemaObject.tables.push({
                        table: tableID
                    })
                }
            }
        })

        let formData = {
            start_time: startTime,
            databases: [{
                database: DATABASE_ID,
                schemas: schemas
            }],
            target_databases: targetDatabases
        }
        console.log(formData)

        $.ajax({
            url: `http://${location.host}${API_URL}/ferdolt/flux/extractions/`,
            type: 'POST',
            headers: {
                'X-CSRFTOKEN': getCookie("csrftoken")
            },
            data: JSON.stringify(formData),
            contentType: "application/json",
            success: function (data) {
                displayMessage("Extraction completed successfully", ["alert", "alert-success", "alert-dismissible"])
                $("#extract-from-database").modal('hide');
            },
            error: function (data) {
                console.log(data.status)

                switch (data.status) {
                    case 404:
                        displayMessage("Error in the url. Please contact the developer")
                        break;
                    case 400:
                        console.log(data.responseJSON)
                        break;
                }
            }
        })
    }

    function synchronizeDatabase() {
        $.ajax({
            type: "POST",
            url: `http://${location.host}${API_URL}/ferdolt/databases/${DATABASE_ID}/synchronize/`,
            headers: {
                "X-CSRFTOKEN": getCookie("csrftoken")
            },
            success: function (data) {
                displayMessage(data['message'], ["alert", "alert-dismissible", "alert-success"])

                setTimeout( () => {
                    location.reload()
                }, 5000 )
            },
            error: function (data) {
                if ([400, 404, 403, 401].includes(data.status)) {
                    switch (data.status) {
                        case 400:
                            displayMessage("Invalid request data " + data.responseJSON)
                            break;
                        case 403:
                            displayMessage("You are not authorized to access this resource")
                            break;
                        case 404:
                            displayMessage("The resource you are trying to access does not exist")
                    }
                } else if (data.status == 500) {
                    displayMessage("A server error occured")
                }
            }
        })
    }

    $(function () {
        $("label[for='new-extraction-start-time'], #new-extraction-start-time-display").daterangepicker({
            singleDatePicker: true,
            timePicker: true,
            showDropdowns: true,
            minYear: 2022,
            maxYear: 2030,
            startDate: moment().startOf('hour'),
            timePicker24Hour: true,
            showSecond: true,
            showMilliSecond: true,
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            }
        }, function (start, end, label) {
            let datetime = start.format('YYYY-MM-DD HH:mm:ss')
            console.log(`Datetime has been picked, value picked: ${datetime}`)

            $("#new-extraction-start-time").val(datetime)
        });
    });

    $(".select-all-tables").change(function () {
        schemaId = $(this).attr('data-schema-id')
        const schema = $(this);
        const checked = $(this).is(':checked');

        $(`.select-table[data-schema-id=${schemaId}]`).each(function () {
            $(this).prop('checked', checked)

            if (checked) {
                NUMBER_OF_SELECTED_TABLES += 1;
            } else {
                NUMBER_OF_SELECTED_TABLES -= 1;
            }
        })

        if (NUMBER_OF_SELECTED_TABLES > 0) {
            $("#action-buttons-container").removeClass('d-none')
            $('.row-1').removeClass('d-none')
        } else {
            $("#action-buttons-container").addClass('d-none')
            $('.row-1').addClass('d-none')
        }
    })

    $('.select-table').change(function () {
        let schemaId = $(this).attr("data-schema-id");
        let checked = $(this).prop('checked')
        let numberOfTables = 0;
        let numberofSelectedTables = 0;

        NUMBER_OF_SELECTED_TABLES += checked ? 1 : -1;

        $(`.select-table[data-schema-id=${schemaId}]`).each(function () {
            numberOfTables++;

            numberofSelectedTables += $(this).prop('checked') ? 1 : 0;
        })

        $(`.select-all-tables[data-schema-id=${schemaId}]`).prop('checked', numberOfTables === numberofSelectedTables)

        if (NUMBER_OF_SELECTED_TABLES > 0) {
            $("#action-buttons-container").removeClass('d-none')
            $('.row-1').removeClass('d-none')
        } else {
            $("#action-buttons-container").addClass('d-none')
            $('.row-1').addClass('d-none')
        }
    })
</script>
{% endif %}
{% endblock %}